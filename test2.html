<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stake with Eternl</title>
    <script src="https://cdn.jsdelivr.net/npm/@emurgo/cardano-serialization-lib-browser"></script>
</head>
<body>
    <button id="stakeButton">Stake to Our Pool</button>

    <script>
        const poolId = "pool1ksye6zwlzaytspldngc3966aj79zkjvmkykydu2txay75c0krfp"; // Replace with your pool's Bech32 ID
        const cardanoSubmitApiUrl = "http://192.168.1.35:6000/api/submit/tx"; // Replace with your Cardano submit-api URL

        async function fetchProtocolParameters() {
            const response = await fetch("https://api.koios.rest/api/v0/epoch_params");
            const params = await response.json();
            const latestParams = params[params.length - 1];
            return {
                linearFee: {
                    minFeeA: latestParams.min_fee_a,
                    minFeeB: latestParams.min_fee_b,
                },
                coinsPerUtxoWord: latestParams.coins_per_utxo_size,
                keyDeposit: latestParams.key_deposit,
                poolDeposit: latestParams.pool_deposit,
                maxTxSize: latestParams.max_tx_size,
            };
        }

        document.getElementById("stakeButton").addEventListener("click", async () => {
            try {
                if (!window.cardano || !window.cardano.eternl) {
                    alert("Eternl Wallet not detected. Please install it to proceed.");
                    return;
                }

                const CSL = window.Cardano;
                const api = await window.cardano.eternl.enable();

                // Fetch protocol parameters
                const protocolParameters = await fetchProtocolParameters();

                // Get user's address and UTXOs
                const usedAddresses = await api.getUsedAddresses();
                const userAddress = CSL.Address.from_bytes(
                    Buffer.from(usedAddresses[0], "hex")
                );
                const utxos = await api.getUtxos();

                // Build inputs
                const inputs = utxos.map((utxoHex) => {
                    const utxo = CSL.TransactionUnspentOutput.from_bytes(Buffer.from(utxoHex, "hex"));
                    return utxo;
                });

                // Build delegation certificate
                const stakeKeyHash = userAddress.to_stake_cred().to_keyhash();
                const stakeCredential = CSL.StakeCredential.from_keyhash(stakeKeyHash);
                const delegationCert = CSL.Certificate.new_stake_delegation(
                    CSL.StakeDelegation.new(
                        stakeCredential,
                        CSL.Ed25519KeyHash.from_bech32(poolId)
                    )
                );

                // Initialize transaction builder
                const txBuilder = CSL.TransactionBuilder.new(
                    CSL.LinearFee.new(
                        CSL.BigNum.from_str(protocolParameters.linearFee.minFeeA.toString()),
                        CSL.BigNum.from_str(protocolParameters.linearFee.minFeeB.toString())
                    ),
                    CSL.BigNum.from_str(protocolParameters.poolDeposit.toString()),
                    CSL.BigNum.from_str(protocolParameters.keyDeposit.toString()),
                    CSL.BigNum.from_str(protocolParameters.coinsPerUtxoWord.toString()),
                    protocolParameters.maxTxSize,
                    5000 // maxValueSize
                );

                // Add inputs and certificate
                inputs.forEach((input) => txBuilder.add_input(input.output().address(), input.input(), input.output().amount()));
                txBuilder.add_certificate(delegationCert);

                // Add change address
                txBuilder.add_change_if_needed(userAddress);

                // Build transaction body
                const txBody = txBuilder.build();
                const txBodyHex = Buffer.from(txBody.to_bytes()).toString("hex");

                // Sign the transaction
                const signedTxHex = await api.signTx(txBodyHex, true);

                // Submit signed transaction via local Cardano submit API
                const response = await fetch(cardanoSubmitApiUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/cbor",
                    },
                    body: Buffer.from(signedTxHex, "hex"),
                });

                if (response.ok) {
                    const txHash = await response.text();
                    alert(`Transaction submitted successfully! Tx Hash: ${txHash}`);
                } else {
                    const error = await response.text();
                    console.error("Error submitting transaction:", error);
                    alert("Failed to submit transaction. Check your API.");
                }
            } catch (error) {
                console.error("Error during staking:", error);
                alert("An error occurred. Please try again.");
            }
        });
    </script>
</body>
</html>
